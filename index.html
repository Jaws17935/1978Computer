<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>損益計算機</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      color: #00ffcc;
      font-family: 'Arial', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      overflow: auto;
      position: relative;
    }

    .dashboard {
      padding: 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      backdrop-filter: blur(10px);
      box-shadow: 0 0 20px rgba(0, 255, 204, 0.5);
      width: 450px;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      margin: 20px;
    }

    .input-section {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }

    .card {
      background: rgba(0, 0, 0, 0.5);
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 0 10px rgba(0, 255, 204, 0.3);
      text-align: center;
      width: 100%;
      box-sizing: border-box;
    }

    .card h1 {
      margin: 0 0 12px;
      font-size: 1.8em;
      color: #00ffcc;
      text-shadow: 0 0 5px rgba(0, 255, 204, 0.7);
    }

    .card label {
      display: block;
      margin: 6px auto 3px;
      color: #00ffcc;
      font-size: 1em;
      font-weight: bold;
      width: fit-content;
    }

    .card input[type="text"] {
      width: 80%;
      max-width: 300px;
      padding: 6px;
      background: rgba(0, 255, 204, 0.1);
      border: 1px solid #00ffcc;
      border-radius: 5px;
      color: #ffffff;
      font-size: 0.9em;
      display: block;
      margin: 0 auto;
      text-align: center;
      box-sizing: border-box;
    }

    .card input[type="text"]:focus {
      outline: none;
      box-shadow: 0 0 10px rgba(0, 255, 204, 0.7);
    }

    .radio-group {
      margin: 4px auto;
      display: flex;
      justify-content: center;
      gap: 12px;
      width: fit-content;
    }

    .radio-group label {
      display: inline;
      margin: 0;
      font-size: 0.9em;
      font-weight: normal;
    }

    .radio-group input[type="radio"] {
      margin-right: 5px;
    }

    .error-message {
      color: #ff3366;
      font-size: 0.9em;
      margin: 4px auto;
      display: block;
      width: fit-content;
    }

    .formula-error {
      color: #ff3366;
      font-size: 0.9em;
      margin: 4px auto;
      display: block;
      width: fit-content;
    }

    .hidden {
      display: none;
    }

    .result {
      margin-top: 10px;
      padding: 5px;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 6px;
      border: 1px solid #00ffcc;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 70%;
      max-width: 250px;
      box-sizing: border-box;
      text-align: center;
      margin-left: auto;
      margin-right: auto;
    }

    .result p {
      margin: 2px 0;
      font-size: 0.9em;
      color: #ffffff;
      width: 100%;
      text-align: center;
    }

    .background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      animation: pulse 5s infinite alternate;
    }

    @keyframes pulse {
      0% { opacity: 0.8; }
      100% { opacity: 1; }
    }

    .weight-input-group {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 80%;
      max-width: 300px;
      margin: 0 auto;
      position: relative;
    }

    .weight-input-group input[type="text"] {
      width: 100%;
      padding: 6px 50px 6px 6px;
      background: rgba(0, 255, 204, 0.1);
      border: 1px solid #00ffcc;
      border-radius: 5px;
      color: #ffffff;
      font-size: 0.9em;
      text-align: center;
      box-sizing: border-box;
    }

    .weight-unit-select {
      position: absolute;
      right: 1px;
      top: 1px;
      bottom: 1px;
      width: 45px;
      padding: 6px;
      background: rgba(0, 255, 204, 0.1);
      border: none;
      border-left: 1px solid #00ffcc;
      border-radius: 0 5px 5px 0;
      color: #ffffff;
      font-size: 0.9em;
      text-align: center;
      box-sizing: border-box;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: none;
    }

    .weight-unit-select:focus {
      outline: none;
    }

    .weight-input-group input[type="text"]:focus {
      outline: none;
      box-shadow: 0 0 10px rgba(0, 255, 204, 0.7);
    }

    .weight-unit-select option {
      background: #0f0c29;
      color: #00ffcc;
    }
  </style>
</head>
<body>
  <div class="background"></div>
  <div class="dashboard">
    <div class="card">
      <div class="input-section">
        <h1>損益計算機</h1>

        <!-- 未知成本 (N) -->
        <div id="section_unknown">
          <!-- 單價 / 總價 -->
          <div class="radio-group">
            <label><input type="radio" name="price_mode" id="price_mode_unit" value="unit" checked tabindex="0"> 單價</label>
            <label><input type="radio" name="price_mode" id="price_mode_total" value="total" tabindex="0"> 總價</label>
          </div>
          <span id="price_mode_error" class="error-message"></span>
          <input type="text" id="product_price" value="0">
          <span id="product_price_error" class="error-message"></span>
          <span id="product_price_formula_error" class="formula-error"></span>
          
          <label for="purchase_quantity">採購數量</label>
          <input type="text" id="purchase_quantity" value="1">
          <span id="purchase_quantity_error" class="error-message"></span>
          <span id="purchase_quantity_formula_error" class="formula-error"></span>
          
          <!-- 需郵費 / 無郵費 -->
          <div class="radio-group">
            <label><input type="radio" name="shipping_included" id="shipping_included_no" value="N" checked tabindex="0"> 無郵費</label>
            <label><input type="radio" name="shipping_included" id="shipping_included_yes" value="Y" tabindex="0"> 需郵費</label>
          </div>
          <span id="shipping_included_error" class="error-message"></span>
          <input type="text" id="inland_shipping" value="0">
          <span id="inland_shipping_error" class="error-message"></span>
          <span id="inland_shipping_formula_error" class="formula-error"></span>
          
          <!-- 修改：商品材數選項 -->
          <div class="radio-group">
            <label><input type="radio" name="material_mode" id="material_mode_normal" value="normal" checked tabindex="0"> 未超材</label>
            <label><input type="radio" name="material_mode" id="material_mode_extra" value="extra" tabindex="0"> 計超材</label>
          </div>
          <span id="material_mode_error" class="error-message"></span>
          <input type="text" id="material_count" value="7" disabled>
          <span id="material_count_error" class="error-message"></span>
          <span id="material_count_formula_error" class="formula-error"></span>
          
          <!-- 重量 (單重 / 總重) -->
          <div class="radio-group">
            <label><input type="radio" name="weight_mode" id="weight_mode_single" value="single" checked tabindex="0"> 單重</label>
            <label><input type="radio" name="weight_mode" id="weight_mode_total" value="total" tabindex="0"> 總重</label>
          </div>
          <span id="weight_mode_error" class="error-message"></span>

          <!-- 重量輸入框 -->
          <div class="weight-input-group">
            <input type="text" id="weight_value" value="1">
            <select id="weight_unit" class="weight-unit-select">
              <option value="g">G</option>
              <option value="kg" selected>KG</option>
            </select>
          </div>
          <span id="weight_value_error" class="error-message"></span>
          <span id="weight_value_formula_error" class="formula-error"></span>

          <label for="exchange_rate">採購匯率</label>
          <input type="text" id="exchange_rate" value="4.5">
          <span id="exchange_rate_error" class="error-message"></span>
          <span id="exchange_rate_formula_error" class="formula-error"></span>
          
          <label for="international_shipping">國際運費</label>
          <input type="text" id="international_shipping" value="35">
          <span id="international_shipping_error" class="error-message"></span>
          <span id="international_shipping_formula_error" class="formula-error"></span>
          
          <label for="platform_commission_rate_n">抽成</label>
          <input type="text" id="platform_commission_rate_n" value="21.5">
          <span id="platform_commission_rate_n_error" class="error-message"></span>
          <span id="platform_commission_rate_n_formula_error" class="formula-error"></span>
          
          <label for="profit_margin_rate_n">實際利潤</label>
          <input type="text" id="profit_margin_rate_n" value="0">
          <span id="profit_margin_rate_n_error" class="error-message"></span>
          <span id="profit_margin_rate_n_formula_error" class="formula-error"></span>
        </div>
      </div>

      <!-- 結果區 -->
      <div class="result" id="result_area" style="display:none;">
        <p id="result_single_weight"></p>
        <p id="result_total_weight"></p> <!-- 總重顯示位置 -->
        <p id="result_single_cost"></p>
        <p id="result_total_cost"></p>
        <p id="result_extra_material_fee"></p> <!-- 新增：超材計價顯示 -->
        <p>建議定價：<span id="suggested_pricing"></span></p>
        <p>定價損益：<span id="suggested_profit_loss"></span></p>
      </div>
    </div>
  </div>

  <script>
    // 快速取得常用元素
    const $ = id => document.getElementById(id);
    const sectionUnknown = $('section_unknown'),
          priceModeUnit = $('price_mode_unit'),
          shippingIncludedYes = $('shipping_included_yes'),
          weightModeSingle = $('weight_mode_single'),
          weightModeTotal = $('weight_mode_total'),
          weightUnitSelect = $('weight_unit'),
          inlandShippingField = $('inland_shipping'),
          resultArea = $('result_area');

    /**
     * evaluateFormula(str):
     * - 先驗證字串只含允許的數字與運算符號
     * - 若合法則用 Function 動態計算
     * - 非法或失敗則回傳 NaN
     */
    const evaluateFormula = str => {
      if (!/^[0-9+\-*/().\s]+$/.test(str)) {
        return NaN;
      }
      try {
        return Function('"use strict"; return (' + str + ');')();
      } catch (e) {
        return NaN;
      }
    };

    // 初始事件設定
    window.addEventListener('DOMContentLoaded', () => {
      // 其餘改變事件: 價格模式 / 郵費 / 重量模式 / 重量單位 / 材數模式
      [
        priceModeUnit,
        $('price_mode_total'),
        shippingIncludedYes,
        $('shipping_included_no'),
        weightModeSingle,
        weightModeTotal,
        weightUnitSelect,
        $('material_mode_normal'),
        $('material_mode_extra')
      ].forEach(el =>
        el.addEventListener('change', () => {
          if (el === shippingIncludedYes || el === $('shipping_included_no')) {
            handleShippingMode();
          } else if (el === $('material_mode_normal') || el === $('material_mode_extra')) {
            handleMaterialMode();
          } else {
            calculate();
          }
        })
      );

      handleShippingMode();
      handleMaterialMode();
      calculate();
      attachEnterKeyListeners();
    });

    // 依是否需郵費切換內地運費欄位
    const handleShippingMode = () => {
      if (shippingIncludedYes.checked) {
        inlandShippingField.style.display = 'block';
        inlandShippingField.disabled = false;
      } else {
        inlandShippingField.style.display = 'none';
        inlandShippingField.value = '0';
        inlandShippingField.disabled = true;
      }
      calculate();
    };

    // 依材數模式切換材數輸入框
    const handleMaterialMode = () => {
      const materialCountField = $('material_count');
      if ($('material_mode_extra').checked) {
        materialCountField.style.display = 'block';
        materialCountField.disabled = false;
        materialCountField.value = '7'; // 預設值設為7
      } else {
        materialCountField.style.display = 'none';
        materialCountField.value = '6';
        materialCountField.disabled = true;
      }
      calculate();
    };

    // 建立跳欄順序 & 綁定事件
    const attachEnterKeyListeners = () => {
      const flowOrder = getFlowOrder();
      flowOrder.forEach((elem, index) => {
        elem.onkeydown = event => {
          if (event.key === 'Enter') {
            event.preventDefault();
            const formula = elem.value.trim();
            if (!formula) {
              elem.value = '0';
              if ($(elem.id + '_formula_error')) $(elem.id + '_formula_error').innerText = '';
            } else {
              const result = evaluateFormula(formula);
              if (!isNaN(result)) {
                elem.value = result;
                if ($(elem.id + '_formula_error')) $(elem.id + '_formula_error').innerText = '';
              } else {
                if ($(elem.id + '_formula_error')) $(elem.id + '_formula_error').innerText = '請輸入正確數值';
              }
            }
            calculate();
            flowOrder[(index + 1) % flowOrder.length].focus();
          }
        };
      });

      // 對所有 input[type="text"] 做額外設定：聚焦、輸入、失焦等
      document.querySelectorAll('input[type="text"]').forEach(input => {
        input.addEventListener('input', e => {
          const value = e.target.value.trim();
          if (!/^[0-9+\-*/().\s]*$/.test(value) && value !== '') {
            if ($(e.target.id + '_formula_error')) $(e.target.id + '_formula_error').innerText = '請輸入正確數值';
          } else {
            if ($(e.target.id + '_formula_error')) $(e.target.id + '_formula_error').innerText = '';
          }
          calculate();
        });
        
        input.addEventListener('focus', e => {
          e.target.select();
        });
        
        input.addEventListener('blur', e => {
          const formula = e.target.value.trim();
          if (!formula) {
            e.target.value = '0';
            if ($(e.target.id + '_formula_error')) $(e.target.id + '_formula_error').innerText = '';
          } else {
            const result = evaluateFormula(formula);
            if (!isNaN(result)) {
              e.target.value = result;
              if ($(e.target.id + '_formula_error')) $(e.target.id + '_formula_error').innerText = '';
            } else {
              if ($(e.target.id + '_formula_error')) $(e.target.id + '_formula_error').innerText = '請輸入正確數值';
            }
          }
          calculate();
        });
      });
    };

    // 動態建立跳欄順序
    const getFlowOrder = () => {
      let flow = [
        priceModeUnit,
        $('price_mode_total'),
        $('product_price'),
        $('purchase_quantity'),
        shippingIncludedYes,
        $('shipping_included_no')
      ];
      if (shippingIncludedYes.checked) {
        flow.push(inlandShippingField);
      }
      // 加入材數選項
      flow.push($('material_mode_normal'), $('material_mode_extra'));
      // weight_mode + weight_unit + weight_value
      flow.push(
        weightModeSingle,
        weightModeTotal,
        $('weight_value'),
        weightUnitSelect,
        $('exchange_rate'),
        $('international_shipping'),
        $('platform_commission_rate_n'),
        $('profit_margin_rate_n')
      );
      return flow;
    };

    // 核心計算
    const calculate = () => {
      document.querySelectorAll('.error-message').forEach(span => (span.innerText = ''));
      document.querySelectorAll('.formula-error').forEach(span => {
        // 如果公式錯誤訊息不是空的，就保留(讓使用者知道輸入有誤)
        if (!span.innerText.includes('請輸入正確數值')) {
          span.innerText = '';
        }
      });
      
      resultArea.style.display = 'none';

      let pCommission = 0,
          pProfit = 0,
          singleCost = 0;

      // 先清空「總重」欄位
      $('result_total_weight').innerText = '';

      const productPriceVal = getValidFloat('product_price', 0, true),
            purchaseQuantityVal = getValidFloat('purchase_quantity', 0.0001, true),
            exchangeRateVal = getValidFloat('exchange_rate', 0.0001, true),
            internationalShippingVal = getValidFloat('international_shipping', 0, true);

      pCommission = getValidFloat('platform_commission_rate_n', 0, true);
      pProfit = getValidFloat('profit_margin_rate_n', 0, true);

      if ([productPriceVal, purchaseQuantityVal, exchangeRateVal, internationalShippingVal, pCommission, pProfit].some(v => v === null)) return;

      const inlandShippingVal = shippingIncludedYes.checked ? getValidFloat('inland_shipping', 0, true) : 0;
      if (shippingIncludedYes.checked && inlandShippingVal === null) return;

      const totalProductCost = priceModeUnit.checked
        ? productPriceVal * purchaseQuantityVal
        : productPriceVal;

      // 先取 rawWeightVal
      const rawWeightVal = getValidFloat('weight_value', 0, true);
      if (rawWeightVal === null) return;

      // 判斷現在是 "g" or "kg" -> 轉成 kg
      const weightUnitFactor = weightUnitSelect.value === 'kg' ? 1 : 0.001;
      const rawWeightValInKg = rawWeightVal * weightUnitFactor;

      // 若是「單重」需 * 數量，若「總重」則不再乘以數量
      const finalWeightVal = weightModeSingle.checked
        ? rawWeightValInKg * purchaseQuantityVal
        : rawWeightValInKg;

      // （商品 + 內地運費）* 匯率
      const costAfterExchange = (totalProductCost + inlandShippingVal) * exchangeRateVal;

      // 計算材數額外運費
      let extraShippingFee = 0;
      if ($('material_mode_extra').checked) {
        const materialCountVal = getValidFloat('material_count', 7, true);
        if (materialCountVal === null) return;
        if (materialCountVal > 6) {
          extraShippingFee = Math.floor(materialCountVal - 6) * 25;
          $('result_extra_material_fee').innerText = `超材計價：${extraShippingFee.toFixed(2)} 元`;
        } else {
          $('result_extra_material_fee').innerText = '';
        }
      } else {
        $('result_extra_material_fee').innerText = '';
      }

      // 國際運費：finalWeightVal (kg) * internationalShippingVal (單位：NT$/kg) + 超材運費
      const internationalShippingTotal = (finalWeightVal * internationalShippingVal) + extraShippingFee;

      // 總成本
      const totalCost = costAfterExchange + internationalShippingTotal;

      // 單成
      singleCost = totalCost / purchaseQuantityVal;

      // 單重
      const singleWeight = finalWeightVal / purchaseQuantityVal;
      $('result_single_weight').innerText = `單重：${singleWeight.toFixed(2)} Kg`;

      // 顯示總重
      $('result_total_weight').innerText = `總重：${finalWeightVal.toFixed(2)} Kg`;

      $('result_single_cost').innerText = `單成：${singleCost.toFixed(2)} 元`;
      $('result_total_cost').innerText = `總成：${totalCost.toFixed(2)} 元`;

      // 通用計算：抽成 + 利潤
      const commissionRate = pCommission / 100,
            profitRate = pProfit / 100;

      const suggestedPricing = (singleCost * (1 + profitRate)) / (1 - commissionRate);
      const finalProfit = (suggestedPricing * (1 - commissionRate)) - singleCost;

      // 顯示結果
      resultArea.style.display = 'block';
      $('suggested_pricing').innerText = suggestedPricing.toFixed(2) + ' 元';
      $('suggested_profit_loss').innerText = finalProfit.toFixed(2) + ' 元';
    };

    /**
     * getValidFloat(id, minVal, required):
     *  - 先用 evaluateFormula() 轉數字
     *  - 檢查是否 >= minVal, 若不合法則回傳 null
     */
    const getValidFloat = (id, minVal, required) => {
      const field = $(id),
            errSpan = $(id + '_error'),
            formulaErrSpan = $(id + '_formula_error'),
            valStr = field ? field.value.trim() : '';

      if (!field) return null;

      if (required && valStr === '') {
        if (errSpan) errSpan.innerText = '為必填項目。';
        return null;
      }
      const valNum = evaluateFormula(valStr);
      if (isNaN(valNum)) {
        if (formulaErrSpan) formulaErrSpan.innerText = '請輸入正確數值';
        return null;
      }
      if (valNum < minVal) {
        if (errSpan) {
          if (id === 'material_count') {
            errSpan.innerText = '基礎為6材，請輸入正確材數';
          } else {
            errSpan.innerText = `不可小於 ${minVal}`;
          }
        }
        return null;
      }
      return valNum;
    };
  </script>
</body>
</html>
